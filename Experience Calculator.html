<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brighter Shores XP Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e2f;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    .container {
      background-color: #2c2c3c;
      padding: 2rem;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      margin-bottom: 2rem;
    }
    label, input {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
    }
    input {
      padding: 0.5rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }
    button {
      padding: 0.7rem;
      width: 100%;
      background-color: #4caf50;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    #result {
      margin-top: 1.5rem;
      font-size: 1.2rem;
    }
    #error {
      color: #ff5555;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      display: none;
    }
    .highlight {
      color: #00ff00 !important;
      font-weight: bold;
    }
    canvas {
      max-width: 1000px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Brighter Shores XP Calculator</h2>
    <label>Penalty Percentage:</label>
    <input type="number" id="penalty" value="0" oninput="validatePenalty()" />
    <div id="error">Invalid number. Please enter a value from -25 to 0.</div>

    <label>Current Level:</label>
    <input type="number" id="currentLevel" value="1" />

    <label>Target Level:</label>
    <input type="number" id="targetLevel" value="10" />

    <label>XP per Action:</label>
    <input type="number" id="xpPerAction" value="100" />

    <button onclick="calculateActions()">Calculate</button>
    <div id="result"></div>
  </div>

  <canvas id="xpChart"></canvas>

  <script>
    function albumXP(L) {
      if (L <= 799) {
        const mod2L = (2 * L) % 5;
        const extra_condition = Math.floor((L - 85) / 168) + 1;
        const extra = mod2L < Math.max(0, extra_condition) ? 5 : 0;
        const term = (245 + mod2L + extra) / 10;
        return Math.ceil(0.3 * L ** 2 + term * L + 250);
      } else {
        return 175 * L + 250;
      }
    }

    function actionsXPPerAction(L, A) {
      let mult = 160;
      if (L <= 5) mult = 2;
      else if (L <= 11) mult = 4;
      else if (L <= 19) mult = 8;
      else if (L <= 799) mult = 40;
      return mult * A;
    }

    function totalXPToLevel(L) {
      let total = 0;
      for (let lvl = 1; lvl < L; lvl++) {
        const A = albumXP(lvl);
        total += actionsXPPerAction(lvl, A);
      }
      return total;
    }

    function validatePenalty() {
      const penaltyInput = document.getElementById('penalty');
      const error = document.getElementById('error');
      let value = parseFloat(penaltyInput.value);

      if (!isNaN(value) && value > 0) {
        value = -Math.abs(value);
        penaltyInput.value = value;
      }

      if (isNaN(value) || value < -25 || value > 0) {
        error.style.display = 'block';
      } else {
        error.style.display = 'none';
      }
    }

    function calculateActions() {
      const penaltyInput = document.getElementById('penalty');
      const error = document.getElementById('error');

      if (error.style.display === 'block') {
        document.getElementById('result').innerText = "Fix the penalty value before calculating.";
        return;
      }

      const penalty = parseFloat(penaltyInput.value);
      const currentLevel = parseInt(document.getElementById('currentLevel').value);
      const targetLevel = parseInt(document.getElementById('targetLevel').value);
      const xpPerAction = parseFloat(document.getElementById('xpPerAction').value);

      if (currentLevel < 0 || targetLevel < 0 || xpPerAction <= 0) {
        document.getElementById('result').innerText = "Please enter valid positive values.";
        return;
      }

      if (targetLevel <= currentLevel) {
        document.getElementById('result').innerText = "No Actions needed. Target level already reached.";
        return;
      }

      const xpNow = totalXPToLevel(currentLevel);
      const xpTarget = totalXPToLevel(targetLevel);
      let xpNeeded = xpTarget - xpNow;
      xpNeeded *= (1 + Math.abs(penalty) / 100);
      const actions = Math.ceil(xpNeeded / xpPerAction);

      document.getElementById('result').innerHTML = `You need approximately <span class="highlight">${actions.toLocaleString()}</span> actions.`;
    }

    function renderGraph() {
      const levels = [];
      const xpTotals = [];
      for (let lvl = 1; lvl <= 2000; lvl++) {
        levels.push(lvl);
        xpTotals.push(totalXPToLevel(lvl));
      }

      new Chart(document.getElementById('xpChart'), {
        type: 'line',
        data: {
          labels: levels,
          datasets: [{
            label: 'Total XP Required to Reach Level',
            data: xpTotals,
            borderColor: '#00ffcc',
            backgroundColor: 'rgba(0, 255, 204, 0.1)',
            borderWidth: 1,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#f0f0f0'
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Level',
                color: '#f0f0f0'
              },
              ticks: {
                color: '#f0f0f0'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Total XP',
                color: '#f0f0f0'
              },
              ticks: {
                color: '#f0f0f0'
              }
            }
          }
        }
      });
    }

    renderGraph();
  </script>
</body>
</html>
